# MarkItDown.GUI

シンプルなドラッグ&ドロップ操作で、様々なファイル形式をMarkdown形式に変換するWindowsアプリケーションです。WebページのスクレイピングによるJSON出力にも対応しています。

## 特徴

- **簡単操作**: ファイルやフォルダをウィンドウにドロップするだけで自動変換
- **多様なファイル形式に対応**: Office文書、PDF、画像、音声、テキスト、アーカイブなど幅広く対応
- **Webスクレイピング**: URLを入力するだけでWebページの内容をJSON形式で抽出・保存
  - Reddit: JSON API による高速取得
  - その他のサイト: Playwright + Ollamaガイド型で動的コンテンツ（ページネーション・無限スクロール等）にも対応
- **自動環境構築**: Python環境、FFmpeg、Ollamaを初回起動時に自動でダウンロード・セットアップ
- **Ollama連携**: ローカルLLM (Ollama) を使用した画像説明の自動生成に対応
- **LLMによる自動整形**: 全ファイル形式の変換結果をOllamaで自動的に整形（元データを損失しない軽量プロンプト）
- **並列処理**: 最大3ファイルの同時変換で高速処理
- **重複処理の回避**: 同じファイルの再処理をキャッシュでスキップ
- **パッケージ自動更新**: 起動時にPythonパッケージ（markitdown、openai、playwright）の最新バージョンを自動確認・更新
- **自動アップデート**: アプリ起動時に最新版を自動チェック・適用
- **モダンなUI**: Avalonia UIを使用した軽量で使いやすいインターフェース（処理中オーバーレイによる進捗表示付き）

## ダウンロード

最新版は以下のGitHub Releasesページからダウンロードできます。

**[📥 ダウンロードページ（GitHub Releases）](https://github.com/1llum1n4t1s/MarkItDown.GUI/releases)**

`Setup.exe` をダウンロードして実行してください。

## サポートしているファイル形式

### テキスト・文書ファイル
- `.txt`, `.html`, `.htm`, `.csv`, `.xml`

### Office文書
- `.docx`, `.doc`, `.xlsx`, `.xls`, `.pptx`, `.ppt`

### PDFファイル
- `.pdf`

### 画像ファイル
- `.jpg`, `.jpeg`, `.png`, `.gif`, `.bmp`, `.tiff`, `.tif`, `.webp`

### 音声ファイル
- `.mp3`, `.wav`, `.flac`, `.aac`, `.ogg`

### アーカイブファイル
- `.zip`, `.rar`, `.7z`, `.tar`, `.gz`

> **注意**: `.md` と `.json` はアプリの出力形式と同一のため、フォルダドロップ時の変換対象から自動的に除外されます。

## 使い方

### ファイル変換

1. アプリケーションを起動します（初回はPython環境・FFmpeg・Ollamaの自動セットアップが行われます）
2. 変換したいファイルまたはフォルダをウィンドウにドラッグ&ドロップします
3. 自動的に変換が開始され、元のファイルと同じ場所にMarkdownファイル（`.md`）が生成されます

変換されたファイルは `ファイル名_YYYYMMDDHHmmss.md` という形式で保存されます。

フォルダをドロップした場合は、フォルダ内のサポート対象ファイルを再帰的に検索し、最大3ファイルずつ並列で変換します。

### Webスクレイピング

1. ウィンドウ上部のURL入力欄にWebページのURLを入力します
2. 「🌐 抽出」ボタンをクリックします
3. スクレイピングが実行され、デスクトップにJSONファイルが保存されます

処理中はオーバーレイに現在の進行状況（依存パッケージ確認 → Playwrightスクレイピング → Ollama JSON整形）がリアルタイムで表示されます。

#### 対応サイト

| サイト種別 | 取得方法 | 特徴 |
|---|---|---|
| Reddit | JSON API | 投稿・コメントを高速取得 |
| その他 | Playwright + Ollama | ヘッドレスブラウザで動的コンテンツに対応 |

#### Ollamaガイド型スクレイピング

Playwright（ヘッドレスブラウザ）とOllama（ローカルLLM）を組み合わせて、以下の動的コンテンツに対応します：

- ページネーション（「次へ」ボタン）
- 「もっと見る」ボタン
- 無限スクロール
- Cookie同意バナーの自動処理

OllamaのOpenAI互換チャットAPI（`/v1/chat/completions`）を使用して、ページの構造を分析し最適なスクレイピング戦略を決定します。

## Ollama連携機能（自動セットアップ）

Ollamaを使用して、以下のLLM連携機能を提供します。

- **画像説明の自動生成**: 画像ファイルをドロップすると、MarkItDownのネイティブLLM統合により画像の説明文を自動生成します
- **Markdown整形**: 全ファイル形式の変換結果を、Ollamaで自動的にきれいなMarkdown形式に整形します（元データを損失しない軽量プロンプト）
- **スクレイピングJSON整形**: Webスクレイピング結果のJSONを構造化・整形します（大きなJSONはチャンク分割で処理）

### 自動セットアップ

**初回起動時に自動的に実行されます：**

1. **Ollamaの自動ダウンロード**
   - アプリケーション起動時、Ollamaが組み込まれていない場合は自動的にダウンロードされます
   - GitHubから最新版のOllama for Windowsを取得します
   - ダウンロード先: `lib/ollama/` フォルダ

2. **Ollamaサーバーの自動起動**
   - ダウンロード完了後、バックグラウンドでOllamaサーバーを起動します
   - `http://localhost:11434` で待機します

3. **ビジョンモデルの自動ダウンロード**
   - `llava` モデルが存在しない場合、自動的にダウンロードを開始します
   - 初回は数GB（モデルサイズ）のダウンロードが発生します
   - ダウンロード中もログに進捗が表示されます

4. **完了**
   - ログに「Ollamaが利用可能です」と表示されれば準備完了です
   - 画像ファイルをドロップすると、自動的に説明が生成されます
   - ファイルをドロップすると、変換後にLLMでMarkdownが整形されます

### 設定のカスタマイズ

設定ファイル `appsettings.xml` で以下をカスタマイズできます：

```xml
<AppSettings>
  <OllamaUrl>http://localhost:11434</OllamaUrl>
  <OllamaModel>llava:34b</OllamaModel>
  <OllamaGpuDevice>0</OllamaGpuDevice>
</AppSettings>
```

#### GPU設定（OllamaGpuDevice）

使用するGPUを指定できます：

- **未設定または`0`** (デフォルト): Ollamaが自動でGPUを検出して使用（推奨）
- **`1`**: GPU 1のみを使用
- **`0,1`**: GPU 0と1の両方を使用
- **`-1`**: CPUのみ使用（GPUを使用しない）

`CUDA_VISIBLE_DEVICES`を設定すると環境によってはGPUが検出されない場合があるため、デフォルトでは未設定（自動検出）にしています。複数GPUで特定のGPUを使いたい場合のみ設定してください。

**GPU IDの確認方法:**
コマンドプロンプトで `nvidia-smi -L` を実行すると、利用可能なGPUのリストが表示されます。

### 使用可能なモデル

- `llava`: 汎用的な画像理解モデル（推奨）
- `llava:13b`: より高精度な大型モデル
- `llava:34b`: 最高精度の大型モデル（高性能PC推奨）

### 注意事項

- **初回起動時の所要時間**: Ollamaとllavaモデルのダウンロードに10～30分程度かかる場合があります（ネットワーク速度に依存）
- **ディスク容量**: Ollama本体（約200MB）+ llavaモデル（約4.5GB）が必要です
- **メモリ要件**: モデル実行時に8GB以上のRAMを推奨します
- Ollamaのダウンロードに失敗した場合でも、画像ファイルの基本情報（ファイル名、サイズなど）は出力されます
- 画像説明の生成には数秒～数十秒かかる場合があります

## 自動環境構築

初回起動時に以下のコンポーネントが自動的にダウンロード・セットアップされます。

| コンポーネント | 用途 | 配置先 |
|---|---|---|
| 埋め込みPython | MarkItDownライブラリの実行環境 | `lib/python/python-embed/` |
| FFmpeg | 音声ファイルの処理 | `lib/ffmpeg/` |
| Ollama | 画像説明生成・Markdown整形・スクレイピング | `lib/ollama/` |
| markitdown[all] | ファイル変換ライブラリ（pip自動インストール・更新） | Python site-packages |
| openai | OllamaのOpenAI互換API利用（pip自動インストール・更新） | Python site-packages |
| playwright | Webスクレイピング用ブラウザ自動化（pip自動インストール・更新） | Python site-packages |

Python環境は公式の埋め込み版を使用し、システムのPython環境には影響しません。

起動時にこれらのPythonパッケージの最新バージョンが自動的に確認・更新されます。

## 動作環境

- Windows 11 (ビルド 26200以降)
- .NET 10.0 Runtime（インストーラーに含まれています）

## 技術仕様

- **フレームワーク**: Avalonia UI 11.3 / .NET 10.0
- **言語**: C# 14 / Python 3.10+
- **アーキテクチャ**: MVVM (Model-View-ViewModel)
- **ファイル変換**: Microsoft MarkItDown（Python）
- **Webスクレイピング**: Playwright（ヘッドレスブラウザ）+ Ollama（構造分析）
- **LLM連携**: Ollama OpenAI互換API (`/v1/chat/completions`)
- **自動更新**: Velopack
- **ログ**: ZLogger（ローリングファイル出力）

## ライセンス

このプロジェクトはMITライセンスの下で公開されています。詳細は [LICENSE](LICENSE) ファイルをご覧ください。
