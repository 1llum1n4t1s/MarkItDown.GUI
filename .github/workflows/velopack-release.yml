name: Velopack リリース

on:
  push:
    branches:
      - releases
      - release/**

permissions:
  contents: write

jobs:
  release:
    runs-on: windows-latest
    steps:
      - name: リポジトリをチェックアウト
        uses: actions/checkout@v4

      - name: リリースバージョンを決定
        shell: pwsh
        run: |
          $refName = '${{ github.ref_name }}'
          if ($refName -match '^release\/(?<version>\d+\.\d+\.\d+)$') {
            $version = $Matches['version']
          } else {
            $version = '1.0.${{ github.run_number }}'
          }
          "VPK_VERSION=$version" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: .NET SDK をセットアップ
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: 依存関係を復元
        run: dotnet restore MarkItDown.GUI/MarkItDown.GUI.csproj

      - name: アプリを発行
        run: dotnet publish MarkItDown.GUI/MarkItDown.GUI.csproj -c Release -o artifacts/publish -r win-x64

      - name: Velopack CLI をインストール
        run: dotnet tool install --global vpk

      - name: Velopack パッケージを作成
        run: |
          vpk pack \
            --packId MarkItDown.GUI \
            --packVersion $env:VPK_VERSION \
            --packDir artifacts/publish \
            --mainExe MarkItDown.GUI.exe \
            --outputDir artifacts/releases

      - name: GitHub Releases へアップロード
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          vpk upload github \
            --repo ${{ github.repository }} \
            --releaseDir artifacts/releases \
            --tag v$env:VPK_VERSION \
            --token $env:GITHUB_TOKEN
