name: Velopack リリース

on:
  push:
    branches:
      - releases

permissions:
  contents: write

jobs:
  release:
    runs-on: windows-latest
    env:
      VPK_VERSION: 1.0.${{ github.run_number }}
    steps:
      - name: リポジトリをチェックアウト
        uses: actions/checkout@v4

      - name: .NET SDK をセットアップ
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: 依存関係を復元
        run: dotnet restore MarkItDown.GUI/MarkItDown.GUI.csproj

      - name: アプリを発行
        run: dotnet publish MarkItDown.GUI/MarkItDown.GUI.csproj -c Release -o artifacts/publish -r win-x64

      - name: Velopack CLI をインストール
        run: dotnet tool install --global vpk

      - name: Velopack パッケージを作成
        run: |
          vpk pack \
            --packId MarkItDown.GUI \
            --packVersion $env:VPK_VERSION \
            --packDir artifacts/publish \
            --mainExe MarkItDown.GUI.exe \
            --outputDir artifacts/releases

      - name: GitHub Releases へアップロード
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          vpk upload github \
            --repo ${{ github.repository }} \
            --releaseDir artifacts/releases \
            --tag v$env:VPK_VERSION \
            --token $env:GITHUB_TOKEN
